name: Shopify Subscription Deep Scanner

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: "CSV filename in repo"
        required: false
        default: "SKU Subscription Data.csv"
      threads:
        description: "Threads per runner (default: 5)"
        required: false
        default: "5"

jobs:
  # ── 20 parallel scan jobs ─────────────────────────────────
  scan:
    name: "Scan Chunk ${{ matrix.chunk }}"
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        chunk: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install playwright pandas tqdm openpyxl
          python -m playwright install chromium
          python -m playwright install-deps chromium

      - name: Run scanner
        env:
          INPUT_FILE:  ${{ github.event.inputs.input_file }}
          OUTPUT_FILE: "output_chunk_${{ matrix.chunk }}.xlsx"
          THREADS:     ${{ github.event.inputs.threads }}
          CHUNK_INDEX: ${{ matrix.chunk }}
          CHUNK_TOTAL: "20"
        run: python shopify_deep_scanner.py

      - name: Upload chunk result
        uses: actions/upload-artifact@v4
        if: always()   # fail hone pe bhi upload karo
        with:
          name: "chunk-${{ matrix.chunk }}"
          path: "output_chunk_${{ matrix.chunk }}.xlsx"
          retention-days: 7

  # ── Merge job ─────────────────────────────────────────────
  merge:
    name: "Merge All Chunks"
    runs-on: ubuntu-latest
    needs: scan
    if: always()   # scan fail ho tab bhi merge karo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pandas openpyxl

      - name: Download all chunk artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./chunks/
          merge-multiple: true

      - name: List downloaded files (debug)
        run: |
          echo "=== Files in ./chunks/ ==="
          find ./chunks -name "*.xlsx" | sort
          echo "=========================="

      - name: Merge chunks
        run: python merge_chunks.py

      - name: Upload final result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "FINAL_Shopify_Deep_Analysis"
          path: "FINAL_Shopify_Deep_Analysis.xlsx"
          retention-days: 30
